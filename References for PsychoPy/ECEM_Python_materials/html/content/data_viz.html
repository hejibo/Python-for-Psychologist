
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Py4ET - Python Open Source Tools in Eye Movement Research 2013 &mdash; 1:40 - 2:40pm Eye Data Visualization</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2013.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Py4ET - Python Open Source Tools in Eye Movement Research 2013" href="../index.html" />
    <link rel="next" title="2:40-3:30 Processing Recorded Eye Data" href="data_processing.html" />
    <link rel="prev" title="1:00 - 1:40pm: Incorporating Eye tracking into PsychoPy Experiments" href="adding_et_func.html" /> 
  </head>
  <body>


<div id="header"  style="background-color: white">
<table width="100%" cellpadding="10">
<tr>
    <td style="text-align:right;vertical-align:middle">
<a href='http://www.nottingham.ac.uk'><img src="../_static/nott_logo.gif" alt="University of Nottingham" /></a>
</td>
</table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="data_processing.html" title="2:40-3:30 Processing Recorded Eye Data"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="adding_et_func.html" title="1:00 - 1:40pm: Incorporating Eye tracking into PsychoPy Experiments"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Py4ET 2013</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">1:40 - 2:40pm Eye Data Visualization</a><ul>
<li><a class="reference internal" href="#plotting-eye-position-traces">Plotting Eye Position Traces</a><ul>
<li><a class="reference internal" href="#example-plots">Example Plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scan-path-visualization-of-eye-sample-data">Scan Path Visualization of Eye Sample Data</a><ul>
<li><a class="reference internal" href="#id1">Example Plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#fixation-distribution-using-heat-map-visualization">Fixation Distribution Using Heat Map Visualization</a><ul>
<li><a class="reference internal" href="#id2">Example Plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#animated-gaze-overlay">Animated Gaze Overlay</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="adding_et_func.html"
                                  title="previous chapter">1:00 - 1:40pm: Incorporating Eye tracking into PsychoPy Experiments</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="data_processing.html"
                                  title="next chapter">2:40-3:30 Processing Recorded Eye Data</a></p>

          <div id="searchbox" style="display: none">
            <h3>Searches</h3>
            <form action="http://www.google.com/cse" id="cse-search-box">
                <input type="hidden" name="cx" value="partner-pub-0861691574026297:eyw5n7-ugep" />
                <input type="hidden" name="ie" value="ISO-8859-1" />
                <input type="text" name="q" size="20" />
                <input type="submit" name="sa" value="Go" />
            </form>
              <p class="searchtip" style="font-size: 90%">
              General
              </p>
            <script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Docs only
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pm-eye-data-visualization">
<span id="datavisualization"></span><h1>1:40 - 2:40pm Eye Data Visualization<a class="headerlink" href="#pm-eye-data-visualization" title="Permalink to this headline">¶</a></h1>
<p>There are seemingly endless ways to visualize and plot data collected from eye
tracking devices. Which types of visualization are most relevant depends directly
on the application / experimental paradigm the eye tracker is being used in,
and the type of data analysis that will be performed on the resulting data collected.</p>
<p>We will review example implementations for the following data visualization / plotting methods:</p>
<p>All the example code for data visualization is available in the python_source/data_visualization folder
of the workshop materials.</p>
<div class="section" id="plotting-eye-position-traces">
<span id="traceplot"></span><h2>Plotting Eye Position Traces<a class="headerlink" href="#plotting-eye-position-traces" title="Permalink to this headline">¶</a></h2>
<p>The basic steps involved in plotting eye position traces collected from an eye tracker
via the ioHub Common Eye Tracker Interface are:</p>
<ol class="arabic simple">
<li>Read Data From ioDataStore</li>
<li>Identify Missing Sample Data Periods (i.e. from Blinks, Eye Occlusion, and Other Causes of Eye Tracking Loss)</li>
<li>Plot the Data (we will use Matplotlib)</li>
</ol>
<p>The following code example outlines these steps. It is assumed that you are running
matplotlib using the windowed graph viewer.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This Python Source File Available in python_source/data_visualization/sample_trace_plot.py</span>

<span class="kn">from</span> <span class="nn">psychopy.iohub.datastore.util</span> <span class="kn">import</span> <span class="n">ExperimentDataAccessUtility</span>
<span class="kn">from</span> <span class="nn">psychopy.iohub</span> <span class="kn">import</span> <span class="n">EventConstants</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="kn">as</span> <span class="nn">mtransforms</span>
<span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="kn">import</span> <span class="n">FontProperties</span>

<span class="kn">from</span> <span class="nn">common_workshop_functions</span> <span class="kn">import</span> <span class="n">processSampleEventGaps</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Load an ioDataStore file containing 120 Hz sample data from a</span>
<span class="c"># remote eye tracker that was recording both eyes. In the plotting example</span>
<span class="n">dataAccessUtil</span><span class="o">=</span><span class="n">ExperimentDataAccessUtility</span><span class="p">(</span><span class="s">&#39;../hdf5_files&#39;</span><span class="p">,</span><span class="s">&#39;remote_data.hdf5&#39;</span><span class="p">,</span> <span class="n">experimentCode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sessionCodes</span><span class="o">=</span><span class="p">[])</span>

<span class="c">##### STEP A. #####</span>
<span class="c"># Retrieve a subset of the BINOCULAR_EYE_SAMPLE event attributes, for events that occurred</span>
<span class="c"># between each time period defined by the TRIAL_START and TRIAL_END trial variables of each entry</span>
<span class="c"># in the trial_conditions data table.</span>
<span class="c">#</span>
<span class="n">event_type</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">BINOCULAR_EYE_SAMPLE</span>
<span class="n">retrieve_attributes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;left_gaze_x&#39;</span><span class="p">,</span><span class="s">&#39;left_gaze_y&#39;</span><span class="p">,</span><span class="s">&#39;left_pupil_measure1&#39;</span><span class="p">,</span>
            <span class="s">&#39;right_gaze_x&#39;</span><span class="p">,</span><span class="s">&#39;right_gaze_y&#39;</span><span class="p">,</span><span class="s">&#39;right_pupil_measure1&#39;</span><span class="p">,</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
<span class="n">trial_event_data</span><span class="o">=</span><span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">getEventAttributeValues</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span>
            <span class="n">retrieve_attributes</span><span class="p">,</span>
            <span class="n">conditionVariablesFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">startConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_START@&#39;</span><span class="p">)},</span>
            <span class="n">endConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_END@&#39;</span><span class="p">)},</span>
            <span class="p">)</span>

<span class="c"># No need to keep the hdf5 file open anymore...</span>
<span class="c">#</span>
<span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Process and plot the sample data for each trial in the data file.</span>
<span class="c">#</span>
<span class="k">for</span> <span class="n">trial_index</span><span class="p">,</span><span class="n">trial_samples</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trial_event_data</span><span class="p">):</span>
    <span class="c">##### STEP B. #####</span>
    <span class="c"># Find all samples that have missing eye position data and filter the eye position</span>
    <span class="c"># and pupil size streams so that the eye track plot is more useful. In this case that</span>
    <span class="c"># means setting position fields to NaN and pupil size to 0.</span>
    <span class="c">#</span>
    <span class="c"># left eye manufacturer specific missing data indicator</span>
    <span class="n">left_eye_invalid_data_masks</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">status</span><span class="o">//</span><span class="mi">10</span><span class="o">&gt;=</span><span class="mi">2</span>
    <span class="c"># Right eye manufacturer specific missing data indicator</span>
    <span class="n">right_eye_invalid_data_masks</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">status</span><span class="o">%</span><span class="mi">10</span><span class="o">&gt;=</span><span class="mi">2</span>
    <span class="c"># Get the needed left eye sample arrays</span>
    <span class="c">#</span>
    <span class="n">left_gaze_x</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">left_gaze_x</span>
    <span class="n">left_gaze_y</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">left_gaze_y</span>
    <span class="n">left_pupil_size</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">left_pupil_measure1</span>
    <span class="c"># Process the left eye fields using the processSampleEventGaps function defined</span>
    <span class="c"># in the common_workshop_functions.py file. The last argument of &#39;clear&#39;</span>
    <span class="c"># tells the function to set any x or y position missing data samples to NaN</span>
    <span class="c"># and to set the pupil size field to 0. The operations are preformed in-place</span>
    <span class="c"># on the numpy arrays passed to the function.</span>
    <span class="c"># The returned valid_data_periods is a list of each group of temporally adjacent</span>
    <span class="c"># samples that are valid, but providing a list where each element is the (start, stop)</span>
    <span class="c"># index for a given period of valid data.</span>
    <span class="c">#</span>
    <span class="n">left_valid_data_periods</span><span class="o">=</span><span class="n">processSampleEventGaps</span><span class="p">(</span><span class="n">left_gaze_x</span><span class="p">,</span><span class="n">left_gaze_y</span><span class="p">,</span>
        <span class="n">left_pupil_size</span><span class="p">,</span>
        <span class="n">left_eye_invalid_data_masks</span><span class="p">,</span>
        <span class="s">&#39;clear&#39;</span><span class="p">)</span>

    <span class="c"># Get the needed right eye sample field arrays</span>
    <span class="c">#</span>
    <span class="n">right_gaze_x</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">right_gaze_x</span>
    <span class="n">right_gaze_y</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">right_gaze_y</span>
    <span class="n">right_pupil_size</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">right_pupil_measure1</span>

    <span class="c"># Process the right eye fields</span>
    <span class="c">#</span>
    <span class="n">right_valid_data_periods</span><span class="o">=</span><span class="n">processSampleEventGaps</span><span class="p">(</span><span class="n">right_gaze_x</span><span class="p">,</span><span class="n">right_gaze_y</span><span class="p">,</span>
        <span class="n">right_pupil_size</span><span class="p">,</span>
        <span class="n">right_eye_invalid_data_masks</span><span class="p">,</span>
        <span class="s">&#39;clear&#39;</span><span class="p">)</span>

    <span class="c"># get the array of sample times for the current trial</span>
    <span class="n">time</span><span class="o">=</span><span class="n">trial_samples</span><span class="o">.</span><span class="n">time</span>
    <span class="c">##### STEP C. #####</span>
    <span class="c"># Plot the sample traces for x and y gaze positions separately for each eye</span>
    <span class="c"># using two sub plots.</span>
    <span class="c">#</span>
    <span class="c"># Get the range to use for the x axis</span>
    <span class="n">tmin</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">//</span><span class="mi">1</span>
    <span class="n">tmax</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">//</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span>

    <span class="c">#Create a 12x8 inch figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="c"># Create a subplot for the left eye, 2,1,1 means the subplot</span>
    <span class="c"># grid will be 2 rows and 1 column, and we are about to create</span>
    <span class="c"># the subplot for row 1 of 2</span>
    <span class="c">#&quot;Left Eye Position&quot;</span>
    <span class="n">left_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">left_gaze_x</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;X Gaze&quot;</span><span class="p">)</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">left_gaze_y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Y Gaze&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span><span class="n">rotation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="c"># Fill in missing eye data areas of the plot with a vertical bar the full</span>
    <span class="c"># height of the sub plot.</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">mtransforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">left_axis</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">left_axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">left_pupil_size</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;DarkRed&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="c">#text(0.5, 0.95, &#39;test&#39;, transform=fig.transFigure, horizontalalignment=&#39;center&#39;)</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Position (pixels)&#39;</span><span class="p">)</span>
    <span class="c"># Left Eye Sample Sub Plot</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Left Eye Position&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c"># Resize the plot x axis by 85% so that the legend , which is outside</span>
    <span class="c"># the plot, will still fit in the matplotlib window.</span>
    <span class="c">#</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">left_axis</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">left_axis</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">box</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
    <span class="n">fontP</span> <span class="o">=</span> <span class="n">FontProperties</span><span class="p">()</span>
    <span class="n">fontP</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="s">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">prop</span> <span class="o">=</span> <span class="n">fontP</span><span class="p">)</span>
    <span class="c"># Right Eye Sample Sub Plot</span>
    <span class="c"># Basically the same as the left eye, but we are adding to the row 2 sub plt now.</span>
    <span class="c">#</span>
    <span class="n">right_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="n">left_axis</span><span class="p">,</span><span class="n">sharey</span> <span class="o">=</span> <span class="n">left_axis</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">right_gaze_x</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;X Gaze&quot;</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="n">right_gaze_y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Y Gaze&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span><span class="n">rotation</span><span class="o">=</span><span class="s">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">mtransforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">right_axis</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">right_axis</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">right_pupil_size</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;DarkRed&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Time&#39;</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Position (Pixels)&#39;</span><span class="p">)</span>
    <span class="n">right_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Right Eye Position&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.125</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&quot;Eye Sample Data For Trial Index </span><span class="si">%d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">trial_index</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c"># Show each trial&#39;s eye sample trace. The program will block until you close</span>
    <span class="c"># the trial plot, and will then open the next trial plt.</span>
    <span class="c">#</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="example-plots">
<h3>Example Plots<a class="headerlink" href="#example-plots" title="Permalink to this headline">¶</a></h3>
<p>Left and Right Eye Position Traces using MatPlotLib</p>
<img alt="Left and Right Eye Position Traces using MatPlotLib" class="align-center" src="../_images/eye_position_traces.png" style="width: 485px; height: 360px;" />
<p>Same Plot as above, zoomed into a Two Second Interval of Eye Position Data</p>
<img alt="Same Plot as above, Zoomed into a Two Second Interval of Eye Position Data" class="align-center" src="../_images/eye_position_traces_zoomed.png" style="width: 485px; height: 360px;" />
</div>
</div>
<div class="section" id="scan-path-visualization-of-eye-sample-data">
<span id="scanpath"></span><h2>Scan Path Visualization of Eye Sample Data<a class="headerlink" href="#scan-path-visualization-of-eye-sample-data" title="Permalink to this headline">¶</a></h2>
<p><strong>Scan path overlay plots</strong> are generally created using either:</p>
<ul class="simple">
<li>the eye tracker sample stream to generate the line segements for the scan path ( <strong>Sample Based Scan Paths</strong> )</li>
<li>the fixation (and possibly saccade) event stream generated by an event parser ( <strong>Fixation / Event Based Scan Paths</strong> )</li>
</ul>
<p>When a scan path overlay is sample based, areas of increased dwell time can usually be seen as the clustering of sample line segments within areas of the scene.</p>
<p>When an event based scan path is used, it is common for each fixation event to be plotted as a circle shape, often with each fixation circle diameter being scaled by the fixation event duration. Saccade events can be represented as lines joining the relevent surrounding fixation events, or fixations can simply be joined by lines anchored to each fixations center point, thereby not attempting to use any available saccadic information (angle, duration, etc.).</p>
<p>The scan path overlay code to follow uses an eye sample based approach.</p>
<p>To aid in the visualization of the temportal order of the sample scan trace, a color map is used, with the color ramp normalized to the start and end time of the sample data being plotted (the trial time). This is often a more effective way of relaying temporal information on the 2D scan path plot compared to cluttering the scan path with numbers giving the trial time of eveny Nth scan path segment, or the sample index, etc.</p>
<p>The basic steps involved in scan path visualization using eye data from the ioDataStore include:</p>
<ol class="upperalpha simple">
<li>Read eye sample (or if available eye fixation and sacade event) data from the ioDataStore.</li>
<li>Clean areas of data that are determined to have missing eye position fields.</li>
<li>Draw the screen background for the trial.</li>
<li>Draw eye position data over the screen background. (What you draw is up to you and will depend on the type of eye information being used in the plot).</li>
<li>Applying a color map to the scan path data using the time of the scan path data points as the reference into the color map.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This Python Source File Available in python_source/data_visualization/scan_path.py</span>

<span class="kn">from</span> <span class="nn">psychopy.iohub.datastore.util</span> <span class="kn">import</span> <span class="n">ExperimentDataAccessUtility</span>
<span class="kn">from</span> <span class="nn">psychopy.iohub</span> <span class="kn">import</span> <span class="n">EventConstants</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">LineCollection</span>

<span class="kn">from</span> <span class="nn">common_workshop_functions</span> <span class="kn">import</span> <span class="n">processSampleEventGaps</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Load an ioDataStore file containing 1000 Hz sample data from a </span>
<span class="c"># head supported eye tracker that was recording the right eye.</span>
<span class="c"># </span>
<span class="n">dataAccessUtil</span><span class="o">=</span><span class="n">ExperimentDataAccessUtility</span><span class="p">(</span><span class="s">&#39;..\hdf5_files&#39;</span><span class="p">,</span><span class="s">&#39;head_supported_data.hdf5&#39;</span><span class="p">,</span> 
                                           <span class="n">experimentCode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sessionCodes</span><span class="o">=</span><span class="p">[])</span>

<span class="c">##### STEP A. #####</span>
<span class="c"># Retrieve a subset of the MONOCULAR_EYE_SAMPLE event attributes, for events that occurred</span>
<span class="c"># between each time period defined by the TRIAL_START and TRIAL_END trial variables of each entry</span>
<span class="c"># in the trial_conditions data table.</span>
<span class="c">#</span>
<span class="n">event_type</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">MONOCULAR_EYE_SAMPLE</span>
<span class="n">retrieve_attributes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;gaze_x&#39;</span><span class="p">,</span><span class="s">&#39;gaze_y&#39;</span><span class="p">,</span><span class="s">&#39;pupil_measure1&#39;</span><span class="p">,</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
<span class="n">trial_event_data</span><span class="o">=</span><span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">getEventAttributeValues</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span>
                            <span class="n">retrieve_attributes</span><span class="p">,</span>
                            <span class="n">conditionVariablesFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="n">startConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_START@&#39;</span><span class="p">)},</span>
                            <span class="n">endConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_END@&#39;</span><span class="p">)})</span>

<span class="c"># No need to keep the hdf5 file open anymore...</span>
<span class="c">#</span>
<span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Process and plot the sample data for each trial in the data file.</span>
<span class="c">#</span>
<span class="k">for</span> <span class="n">trial_index</span><span class="p">,</span><span class="n">trial_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trial_event_data</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    <span class="c">##### STEP B. #####</span>
    <span class="c"># Find all samples that have missing eye position data and filter the eye position</span>
    <span class="c"># and pupil size streams so that the eye track plot is more useful. In this case that</span>
    <span class="c"># means setting position fields to NaN and pupil size to 0.</span>
    <span class="c">#</span>
    
    <span class="c"># Eye manufacturer specific missing data indicator</span>
    <span class="c">#</span>
    <span class="n">invalid_data_mask</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span><span class="o">==</span><span class="mi">0</span>

    
    <span class="c"># Get the needed left eye sample arrays </span>
    <span class="c">#</span>
    <span class="n">gaze_x</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_x</span>
    <span class="n">gaze_y</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_y</span>
    <span class="n">pupil_size</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span>
    
    <span class="c"># Process the eye fields using the processSampleEventGaps function defined</span>
    <span class="c"># in the common_workshop_functions.py file. The last arguement of &#39;clear&#39;</span>
    <span class="c"># tells the function to set any x or y position missing data samples to NaN </span>
    <span class="c"># and to set the pupil size field to 0. The operations are preformed in-place</span>
    <span class="c"># on the numpy arrays passed to the function.</span>
    <span class="c"># The returned valid_data_periods is a list of each group of temporally adjacent </span>
    <span class="c"># samples that are valid, but providing a list where each element is the (start, stop)</span>
    <span class="c"># index for a given period of valid data.</span>
    <span class="c">#</span>
    <span class="n">valid_data_periods</span><span class="o">=</span><span class="n">processSampleEventGaps</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span><span class="n">gaze_y</span><span class="p">,</span>
                                                   <span class="n">pupil_size</span><span class="p">,</span>
                                                   <span class="n">invalid_data_mask</span><span class="p">,</span>
                                                   <span class="s">&#39;clear&#39;</span><span class="p">)</span>
                                                   
    <span class="c"># get the array of sample times for the current trial</span>
    <span class="c">#</span>
    <span class="n">time</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">time</span>

    <span class="c"># Start plotting for the trial</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="c">##### STEP C. #####</span>
    <span class="c"># Create Image background for each trial scanpath</span>
    <span class="c"># Get the condition variable set used for the current trial</span>
    <span class="c">#</span>
    <span class="n">condition_set</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">condition_set</span>    
    <span class="c"># Get the image name and trial_id from the condition data for</span>
    <span class="c"># the trial.</span>
    <span class="c">#</span>
    <span class="n">image_name</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">IMAGE_NAME</span>
    <span class="n">trial_id</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">trial_id</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Trial {0}: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial_id</span><span class="p">,</span><span class="n">image_name</span><span class="p">))</span>
    <span class="c"># Load the image</span>
    <span class="c">#</span>
    <span class="n">trial_image_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;./images/&quot;</span><span class="o">+</span><span class="n">image_name</span><span class="p">))</span>
    <span class="c"># Get background image size</span>
    <span class="c">#</span>
    <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ihw</span><span class="p">,</span><span class="n">ihh</span><span class="o">=</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="c"># Draw the image to the plot</span>
    <span class="c">#</span>
    <span class="n">bip</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">trial_image_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">,</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">))</span>
    
    <span class="c">##### STEP D. #####</span>
    <span class="c"># To create the scan path data for the plot, convert the two 1D numpy</span>
    <span class="c"># arrays into one 2D array of shape (num_samples,2), where the second</span>
    <span class="c"># dimention is the x,y position for every sample in num_samples.</span>
    <span class="c">#</span>
    <span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c"># To create the csan path graphics, we will create one line for every sample</span>
    <span class="c"># position point by specifying the start and end point of each line as</span>
    <span class="c"># x1,y1,x2,y2 ... xn-1,yn-1,xn,yn, where n == the number of sample points</span>
    <span class="c"># in the trial.</span>
    <span class="c">#</span>
    <span class="n">sample_segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sample_points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sample_points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Create the actual matplotlib line graphics group, and use the built in</span>
    <span class="c"># color map &#39;YlOrRd&#39;, meaning Yellow-&gt;Orange-&gt;Red</span>
    <span class="c">#</span>
    <span class="n">scan_path_line_collection</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">sample_segments</span><span class="p">,</span> 
                                               <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;YlOrRd&#39;</span><span class="p">),</span>
                                               <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">scan_path_line_collection</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">scan_path_line_collection</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">scan_path_line_collection</span><span class="p">)</span>
    
    <span class="c">##### STEP E. #####</span>
    <span class="c"># Display the color bar and different sample times associated with the </span>
    <span class="c"># different colors in the color range.</span>
    <span class="c">#</span>
    <span class="n">cb</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scan_path_line_collection</span><span class="p">)</span>

    <span class="c"># Give the Color Bar a title</span>
    <span class="c">#</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&quot;Trial Time (sec)&quot;</span><span class="p">)</span> 

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
</pre></div>
</div>
<div class="section" id="id1">
<h3>Example Plots<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Right Eye Scan Path Using Eye Sample Data. Created with MatPlotLib</p>
<img alt="Right Eye Scan Path Using Eye Sample Data. Created with MatPlotLib." class="align-center" src="../_images/scan_path.png" style="width: 485px; height: 365px;" />
<p>Same Plot as above, Zoomed into a Small Area of the Image Viewed.</p>
<img alt="Same Plot as above, Zoomed into a Small Area of the Image Viewed." class="align-center" src="../_images/scan_path_zoomed.png" style="width: 480px; height: 360px;" />
</div>
</div>
<div class="section" id="fixation-distribution-using-heat-map-visualization">
<span id="heatmap"></span><h2>Fixation Distribution Using Heat Map Visualization<a class="headerlink" href="#fixation-distribution-using-heat-map-visualization" title="Permalink to this headline">¶</a></h2>
<p>The basic steps involved in Fixation Distribution Using Heat Map Visualization
using eye data from the ioDataStore:</p>
<p>X. Load the eye data from the ioDataStore (in this example we will just create simulated fixation data to spare time).
A. Define settings to control how fixation data is used to great the heat map, and how the heat map should look.
B. Create 2D Gaussian Mask templateto use as the fixation denisity map for each fixation being used.
C. Load the background image displayed during eye data collection.
D. In our example, create some random fixation data.
E. Create the fixation density map based on the variable values specified in A, the gaussian created in B., and the Fixation data either loaded in X., or in our case, created in D.
F. Turn the fixation density map into a heat map by applying a color range to the fixation map data.
G. (Optional) Create a figure plotting</p>
<blockquote>
<div># Gausian mask being used.
# Background image the heatmap will be applied to.
# The fixation data points used in creating the fixation density map.
# The heat map created which will be overlayed on the background image.</div></blockquote>
<ol class="upperalpha simple" start="8">
<li>Create the final fixation denisity based heat map overlayed on the background image.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This Python Source File Available in python_source/data_visualization/heat_map.py</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="kn">as</span> <span class="nn">plb</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">scoreatpercentile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c">##### STEP A. #####</span>
<span class="c"># Define the value for settings when creating the heat map.</span>
<span class="c">#</span>
<span class="c"># We will use a sigma 33 pixels for the gaussian distribution applied to</span>
<span class="c"># the fixation density map for each fixation position, which</span>
<span class="c"># = ~ 2 visual degrees on a 1024x768 monitor when viewed at 60 cm.</span>
<span class="c">#</span>
<span class="n">sigma_x</span> <span class="o">=</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="mf">33.0</span>
<span class="c"># If fixation duration is used to weight each fixation when added to the </span>
<span class="c"># fixation density array, these two variables specify the min and max fixation </span>
<span class="c"># duration that will be applied.</span>
<span class="c">#</span>
<span class="n">min_fix_duration</span><span class="o">=</span><span class="mi">0</span>
<span class="n">max_fix_duration</span><span class="o">=</span><span class="mi">500</span>
<span class="c"># use_dwell_time_weighting:</span>
<span class="c"># True : Each fixations impact on the fixation map is linearly proprotional </span>
<span class="c">#        to the fixation dwell time within the fixation duration range </span>
<span class="c">#        min_fix_duration to max_fix_duration</span>
<span class="c"># False: Fixations are still filtered by min_fix_duration, max_fix_duration; </span>
<span class="c">#        however each fixation provides equal weight to the fixtion map, </span>
<span class="c">#        regardless of duration.</span>
<span class="c">#</span>
<span class="n">use_dwell_time_weighting</span><span class="o">=</span><span class="bp">True</span>
<span class="c"># Percentile range of fixation map distribution to include in heat map </span>
<span class="c"># calculation.</span>
<span class="c">#</span>
<span class="n">fix_perc_range</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mo">05</span><span class="p">,</span><span class="o">.</span><span class="mi">95</span><span class="p">]</span>
<span class="c"># Percentile floor of fixation map distribution for heat map visualization</span>
<span class="c">#</span>
<span class="n">min_fix_dist_perc</span><span class="o">=</span><span class="mi">10</span>
<span class="c"># We will be creating simulated fixation data, this specifies the number of </span>
<span class="c"># fixation points to create.</span>
<span class="c">#</span>
<span class="n">sim_fix_count</span><span class="o">=</span><span class="mi">500</span>
 
<span class="c">##### STEP B. #####</span>
<span class="c"># Create 2D Gaussian Mask template as a 2D numpy array</span>
<span class="c">#</span>
<span class="c"># Create x and y pixel ranges for Gauss Mask.</span>
<span class="c">#</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">sigma_x</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span><span class="n">sigma_x</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">sigma_y</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">sigma_y</span><span class="o">*</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c"># Create X and Y pixel position values for each element of Gauss. Mask.</span>
<span class="c">#</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c"># Create 2D Gauss Mask as numpy array using X and Y mesh grid data</span>
<span class="c"># and sigma&#39;s, with Gauss centered in 2D array (0,0)</span>
<span class="c">#</span>
<span class="n">gauss</span><span class="o">=</span><span class="n">plb</span><span class="o">.</span><span class="n">bivariate_normal</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># Normalize the Gausian, such that the max value in the is 1.0.</span>
<span class="c">#</span>
<span class="n">gauss</span><span class="o">*=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">gauss</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">ghw</span><span class="p">,</span><span class="n">ghh</span><span class="o">=</span><span class="n">gauss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">gauss</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span>

<span class="c">##### STEP C. #####</span>
<span class="c"># Load Background Image Displayed During Eye Data Collection </span>
<span class="c"># Flip vertically</span>
<span class="c">#</span>
<span class="n">image_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;./images/canal.jpg&quot;</span><span class="p">))</span>    
<span class="c"># Get background image size</span>
<span class="c">#</span>
<span class="n">image_size</span><span class="o">=</span><span class="n">image_array</span><span class="o">.</span><span class="n">shape</span><span class="c">#(image_array.shape[0],image_array.shape[1])</span>
<span class="n">ihw</span><span class="p">,</span><span class="n">ihh</span><span class="o">=</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>

<span class="c">##### STEP D. #####</span>
<span class="c"># Create some Random Fixation Data</span>
<span class="c">#</span>
<span class="c"># Here, the fixation event data is being simulated as sim_fix_count fixations</span>
<span class="c"># of random position within center 50% of fixation density map (since it</span>
<span class="c"># is created with 2*width, 2*height of the image that the fixation density map</span>
<span class="c"># will be applied to).Random fixation durations between 150 and 1500 msec </span>
<span class="c"># are used.</span>
<span class="c">#</span>
<span class="n">border</span><span class="o">=</span><span class="mi">10</span>
<span class="n">fix_duration_range</span><span class="o">=</span><span class="n">min_fix_duration</span><span class="p">,</span><span class="n">max_fix_duration</span>
<span class="n">fixation_x_range</span><span class="o">=-</span><span class="n">ihw</span><span class="o">+</span><span class="n">border</span><span class="p">,</span> <span class="n">ihw</span><span class="o">-</span><span class="n">border</span>
<span class="n">fixation_y_range</span><span class="o">=-</span><span class="n">ihh</span><span class="o">+</span><span class="n">border</span><span class="p">,</span> <span class="n">ihh</span><span class="o">-</span><span class="n">border</span>

<span class="c"># Create the dummy Fixation Data as a 3x500 numpy array</span>
<span class="c">#</span>
<span class="n">fix_pos</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">*</span><span class="n">fixation_y_range</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sim_fix_count</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">*</span><span class="n">fixation_x_range</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sim_fix_count</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">*</span><span class="n">fix_duration_range</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sim_fix_count</span><span class="p">)))</span>

<span class="c">##### STEP E. #####</span>
<span class="c"># Create the Fixation Density Map Layer based on </span>
<span class="c"># the Gauss Mask Template and the Fixation Data</span>
<span class="c"># Start with empty 2D numpy array 2x size of background image to be used </span>
<span class="c"># (this makes applying Gauss mask for each fixation easier as array clipping</span>
<span class="c"># is not a consern.). The density map will be trimmed back to the center</span>
<span class="c"># 50% later.</span>
<span class="c">#</span>
<span class="n">fixation_map</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

<span class="c"># Apply Gaussian Mask for each fixation position to the density array</span>
<span class="c"># based on the created fixation event data.</span>
<span class="c">#</span>

<span class="k">if</span> <span class="n">use_dwell_time_weighting</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="n">fix_dur</span> <span class="ow">in</span> <span class="n">fix_pos</span><span class="p">:</span>
        <span class="n">fx</span><span class="o">+=</span><span class="n">ihh</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">fy</span><span class="o">+=</span><span class="n">ihw</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">fixation_map</span><span class="p">[</span><span class="n">fy</span><span class="o">-</span><span class="n">ghh</span><span class="p">:</span><span class="n">fy</span><span class="o">+</span><span class="n">ghh</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">fx</span><span class="o">-</span><span class="n">ghw</span><span class="p">:</span><span class="n">fx</span><span class="o">+</span><span class="n">ghw</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">gauss</span><span class="o">*</span><span class="n">fix_dur</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="n">fix_dur</span> <span class="ow">in</span> <span class="n">fix_pos</span><span class="p">:</span>
        <span class="n">fx</span><span class="o">+=</span><span class="n">ihh</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">fy</span><span class="o">+=</span><span class="n">ihw</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">fixation_map</span><span class="p">[</span><span class="n">fy</span><span class="o">-</span><span class="n">ghh</span><span class="p">:</span><span class="n">fy</span><span class="o">+</span><span class="n">ghh</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">fx</span><span class="o">-</span><span class="n">ghw</span><span class="p">:</span><span class="n">fx</span><span class="o">+</span><span class="n">ghw</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">gauss</span>

<span class="n">fixation_map</span><span class="o">=</span><span class="n">fixation_map</span><span class="p">[</span><span class="n">ihw</span><span class="p">:</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ihw</span><span class="p">,</span><span class="n">ihh</span><span class="p">:</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ihh</span><span class="p">]</span>
<span class="c"># Apply fixation duration and distribution pertentile heuristics to heat map:</span>
<span class="c">#</span>
<span class="n">fixation_map_min</span><span class="o">=</span><span class="n">fixation_map</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">fixation_map_max</span><span class="o">=</span><span class="n">fixation_map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">fix_range</span><span class="o">=</span><span class="n">fixation_map_max</span><span class="o">-</span><span class="n">fixation_map_min</span>
<span class="n">fix_range</span><span class="o">=</span><span class="n">fixation_map_min</span><span class="o">+</span><span class="n">fix_perc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fix_range</span><span class="p">,</span><span class="n">fixation_map_min</span><span class="o">+</span><span class="n">fix_perc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fix_range</span>
<span class="n">min_fix_map_value</span><span class="o">=</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">fixation_map</span><span class="p">,</span> <span class="n">min_fix_dist_perc</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">fix_range</span><span class="p">)</span>
<span class="n">fix_floor_value</span><span class="o">=</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">fixation_map</span><span class="p">,</span> <span class="n">fix_perc_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">fix_ceil_value</span><span class="o">=</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">fixation_map</span><span class="p">,</span> <span class="n">fix_perc_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span>

<span class="n">fixation_map</span><span class="p">[</span><span class="n">fixation_map</span><span class="o">&lt;</span><span class="n">fix_floor_value</span><span class="p">]</span><span class="o">=</span><span class="n">fix_floor_value</span>
<span class="n">fixation_map</span><span class="p">[</span><span class="n">fixation_map</span><span class="o">&gt;</span><span class="n">fix_ceil_value</span><span class="p">]</span><span class="o">=</span><span class="n">fix_ceil_value</span>
<span class="n">fixation_map</span><span class="p">[</span><span class="n">fixation_map</span><span class="o">&lt;</span><span class="n">min_fix_map_value</span><span class="p">]</span><span class="o">=</span><span class="n">min_fix_map_value</span>


<span class="c">##### STEP F. #####</span>
<span class="c"># Plot the Fixation Gaussian, the Simulated Fixation Points,</span>
<span class="c"># the resulting Fixation Density Map, and the background image</span>
<span class="c"># to be used for illustrative purposes.</span>
<span class="c">#</span>

<span class="c">#Create a 12x8 inch figure</span>
<span class="c">#</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&quot;Components in Creating a Fixation Density Based Heat Map&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="c"># Figure will have 2 x 2 subplots</span>
<span class="c">#</span>
<span class="n">gauss_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#left_axis.set_ylabel(&#39;Position (pixels)&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ghh</span><span class="p">,</span> <span class="n">ghh</span><span class="p">,</span><span class="o">-</span><span class="n">ghw</span><span class="p">,</span> <span class="n">ghw</span><span class="p">))</span>
<span class="n">gauss_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Gaussian Mask Used for Each Fixation&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">gauss_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Pixels&#39;</span><span class="p">)</span>

<span class="c"># Display the background image.</span>
<span class="c">#</span>
<span class="n">image_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">,</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">))</span>
<span class="n">image_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Background Image&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="c"># Plot the simulated fixation data.</span>
<span class="c">#</span>
<span class="n">fix_point_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">fix_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">fix_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="n">fix_pos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fix_point_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Simulated Fixation Point Data.</span><span class="se">\n</span><span class="s">Point Size Proportional to Fixation Duration&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">fix_point_axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Pixels&#39;</span><span class="p">)</span>
<span class="n">fix_point_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Pixels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">))</span>
<span class="c"># Plot fixation density mask using a Yellow-&gt;Orange-&gt;Red Color Map,</span>
<span class="c"># clipped to center 50% of </span>
<span class="c">#.</span>
<span class="n">heat_map_axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">clmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;YlOrRd&#39;</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fixation_map</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span> 
                                <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span>
                                <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">,</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">),</span>
                                <span class="n">cmap</span><span class="o">=</span><span class="n">clmap</span><span class="p">)</span>           
<span class="n">heat_map_axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&quot;Heat Map for the Fixation Density Map.&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">heat_map_axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Pixels&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
  
<span class="c">###### STEP G. #####</span>
<span class="c">## Putting it all Together: Heat Map Representation of Fixation Position </span>
<span class="c">## and Dwell Time Density During Image Viewing</span>
<span class="c">##</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">&quot;Fixation Density Heat Map&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

<span class="c">## Draw the background Image</span>
<span class="c">#</span>
<span class="n">image_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;./images/canal.jpg&quot;</span><span class="p">))</span>    
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">,</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">))</span>
<span class="c"># Create RGBA values for the color map created above.</span>
<span class="c"># Set the Color Map Transparency to Increase as a Function of Fixation Dwell Time.  </span>
<span class="c">#</span>
<span class="n">clmap</span><span class="o">.</span><span class="n">_init</span><span class="p">()</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">clmap</span><span class="o">.</span><span class="n">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
<span class="n">clmap</span><span class="o">.</span><span class="n">_lut</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphas</span>
<span class="c"># Draw the Fixation Map Mask over the Background Image using the Color Map:</span>
<span class="c">#</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fixation_map</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">,</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">),</span><span class="n">cmap</span><span class="o">=</span><span class="n">clmap</span><span class="p">)</span>
<span class="c"># Display the Heat Map Scale:</span>
<span class="c">#</span>
<span class="n">cb</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="k">if</span> <span class="n">use_dwell_time_weighting</span><span class="p">:</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&quot;Fixation Density (msec scale)&quot;</span><span class="p">)</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&quot;Fixation Density (count scale)&quot;</span><span class="p">)</span> 
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="id2">
<h3>Example Plots<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Components used in creating a fixation density based heat map.</p>
<img alt="Components used in creating a fixation density based heat map." class="align-center" src="../_images/heat_map_components.png" style="width: 700px; height: 500px;" />
<p>The final heat map result.</p>
<img alt="The final heat map result" class="align-center" src="../_images/heat_map.png" style="width: 700px; height: 500px;" />
</div>
</div>
<div class="section" id="animated-gaze-overlay">
<span id="gazeoverlay"></span><h2>Animated Gaze Overlay<a class="headerlink" href="#animated-gaze-overlay" title="Permalink to this headline">¶</a></h2>
<p>Here we illustrate a cute, but perhaps not so scientifically useful,
animated gaze position overlay cursor.</p>
<p>The basic steps involved in creating an Animated Gaze Overlay
using eye data from the ioDataStore:</p>
<ol class="upperalpha simple">
<li>Load the eye sample data from the ioDataStore.</li>
<li>Clean position and pupil data for samples tagged as having missing eye data.</li>
<li>Load the background image used for the trial selected for the gaze overlay playback.</li>
<li>Create the matplotlib animated figure, including the gaze overlay graphic.</li>
<li>Start the animation.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This Python Source File Available in python_source/data_visualization/gaze_overlay_animation.py</span>

<span class="c"># This is a slightly more advanced demo to show you fancy things like animations</span>
<span class="c">#</span>
<span class="c"># It&#39;s based on a how-to about python plotting animations at</span>
<span class="c"># http://nickcharlton.net/posts/drawing-animating-shapes-matplotlib.html</span>
<span class="c"># It is also possible to save the animation as a video file</span>

<span class="kn">from</span> <span class="nn">psychopy.iohub.datastore.util</span> <span class="kn">import</span> <span class="n">ExperimentDataAccessUtility</span>
<span class="kn">from</span> <span class="nn">psychopy.iohub</span> <span class="kn">import</span> <span class="n">EventConstants</span>

<span class="c">#import some maths/plotting libs</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>

<span class="c">#import our own helper funcs (from the python_source folder)</span>
<span class="kn">from</span> <span class="nn">common_workshop_functions</span> <span class="kn">import</span> <span class="n">processSampleEventGaps</span>

<span class="c">##### STEP A. #####</span>
<span class="c"># Load an ioDataStore file containing 1000 Hz sample data from a </span>
<span class="c"># head supported eye tracker that was recording the right eye. </span>
<span class="n">dataAccessUtil</span><span class="o">=</span><span class="n">ExperimentDataAccessUtility</span><span class="p">(</span><span class="s">&#39;../hdf5_files&#39;</span><span class="p">,</span>
                                           <span class="s">&#39;head_supported_data.hdf5&#39;</span><span class="p">,</span> 
                                           <span class="n">experimentCode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">sessionCodes</span><span class="o">=</span><span class="p">[])</span>

<span class="n">TRIAL_ID</span><span class="o">=</span><span class="mi">1</span> <span class="c">#we&#39;ll just play back a single trial here</span>
<span class="n">et_sampling_rate</span><span class="o">=</span><span class="mf">1000.0</span> <span class="c">#eye tracker sampling rate</span>
<span class="n">desired_playback_rate</span><span class="o">=</span><span class="mi">20</span> <span class="c">#what rate (in Hz) will we update our figure (not every eye frame!)</span>

<span class="c"># Retrieve a subset of the MONOCULAR_EYE_SAMPLE event attributes, for events that occurred</span>
<span class="c"># between each time period defined by the TRIAL_START and TRIAL_END trial variables of each entry</span>
<span class="c"># in the trial_conditions data table.</span>
<span class="n">event_type</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">MONOCULAR_EYE_SAMPLE</span>
<span class="n">retrieve_attributes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;gaze_x&#39;</span><span class="p">,</span><span class="s">&#39;gaze_y&#39;</span><span class="p">,</span><span class="s">&#39;pupil_measure1&#39;</span><span class="p">,</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
<span class="n">trial_event_data</span><span class="o">=</span><span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">getEventAttributeValues</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span>
                            <span class="n">retrieve_attributes</span><span class="p">,</span>
                            <span class="n">conditionVariablesFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="n">startConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_START@&#39;</span><span class="p">)},</span>
                            <span class="n">endConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_END@&#39;</span><span class="p">)})</span>

<span class="c"># No need to keep the hdf5 file open anymore...</span>
<span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Get the data for the one trial we will playback</span>
<span class="n">trial_data</span><span class="o">=</span><span class="n">trial_event_data</span><span class="p">[</span><span class="n">TRIAL_ID</span><span class="p">]</span>

<span class="c">##### STEP B. #####</span>
<span class="c"># Get the needed left eye sample arrays </span>
<span class="n">gaze_x</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_x</span>
<span class="n">gaze_y</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_y</span>
<span class="n">pupil_size</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span>
<span class="c"># get the array of sample times for the current trial</span>
<span class="n">time</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">time</span>
<span class="c">#clear absent data</span>
<span class="n">invalid_data_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="c">#vendor specific codes</span>
<span class="n">valid_data_periods</span><span class="o">=</span><span class="n">processSampleEventGaps</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span><span class="n">gaze_y</span><span class="p">,</span>
                                               <span class="n">pupil_size</span><span class="p">,</span>
                                               <span class="n">invalid_data_mask</span><span class="p">,</span>
                                               <span class="s">&#39;clear&#39;</span><span class="p">)</span>

<span class="c">##### STEP C. #####       </span>
<span class="c"># Load the image used in the current trial.                                        </span>
<span class="c"># get the trial condition values used for each trial in example experiment.</span>
<span class="n">condition_set</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">condition_set</span> 
<span class="c"># Get the image name used for display during the trial</span>
<span class="n">image_name</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">IMAGE_NAME</span>
<span class="n">trial_id</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">trial_id</span>

<span class="c"># load the image as a numpy array</span>
<span class="n">trial_image_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;./images/&quot;</span><span class="o">+</span><span class="n">image_name</span><span class="p">))</span>

<span class="c"># Reduce size for easier viewing</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>

<span class="c">##### STEP D. #####</span>
<span class="c"># Create the Animated Figure</span>
<span class="n">dpi</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">margin</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="c"># (add 5% of the width/height of the figure...)</span>

<span class="c"># Make a figure big enough to accomodate an axis of xpixels by ypixels</span>
<span class="c"># as well as the ticklabels, etc...</span>
<span class="n">figsize</span> <span class="o">=</span>  <span class="n">w</span> <span class="o">/</span> <span class="n">dpi</span><span class="p">,</span>  <span class="n">h</span> <span class="o">/</span> <span class="n">dpi</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Trial </span><span class="si">%i</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">trial_id</span><span class="p">,</span><span class="n">image_name</span><span class="p">))</span>
<span class="c"># get the current axes</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="c"># Draw the background image array</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">trial_image_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

<span class="c"># Create a circle graphic to use as the gaze overlay cursor.</span>
<span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">,</span> 
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                    
<span class="c"># Create a semi-transparent text box to display the current trial time.</span>
<span class="n">time_text</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
                    <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;facecolor&#39;</span><span class="p">:</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="s">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s">&#39;pad&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

<span class="c"># Calculate the eye trackers sampling rate in msec.</span>
<span class="n">ifi</span><span class="o">=</span><span class="mf">1000.0</span><span class="o">/</span><span class="n">et_sampling_rate</span>
<span class="c"># Calculate how many samples occur within the requested playback rate.</span>
<span class="n">sample_frame_interval</span><span class="o">=</span><span class="n">desired_playback_rate</span><span class="o">//</span><span class="n">ifi</span><span class="o">+</span><span class="mi">1</span> <span class="c">#note that // means integer divide</span>
<span class="n">actual_playback_rate</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sample_frame_interval</span><span class="o">*</span><span class="n">ifi</span><span class="p">)</span> <span class="c">#true rate after rounding</span>
<span class="n">sample_frame_count</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">/</span><span class="n">sample_frame_interval</span><span class="p">)</span> <span class="c">#true n frames after rounding</span>

<span class="c"># Create the matplotlib Animation object</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This gets called each time the animation first starts.</span>
<span class="sd">    You must return any of the plot graphics that change</span>
<span class="sd">    Each frame of the animation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;time = </span><span class="si">%.1f</span><span class="s"> sec&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">circle</span><span class="p">,</span><span class="n">time_text</span>

<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This gets called each frame of the animation.</span>
<span class="sd">    This is where the animated graphics can be updated for the next frame.</span>
<span class="sd">    You must return any of the plot graphics that change</span>
<span class="sd">    Each frame of the animateion.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">sample_frame_interval</span><span class="p">)</span>
    <span class="n">circle</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">gaze_x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">time_text</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">&#39;time = </span><span class="si">%.1f</span><span class="s"> sec&#39;</span> <span class="o">%</span> <span class="n">time</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">circle</span><span class="p">,</span><span class="n">time_text</span>

<span class="c"># Start the animation, but only play it for 1 frame</span>
<span class="c"># (This gets around a current bug in the matplotlib animation code when</span>
<span class="c"># you want to use blit=True during the real playback; which you do as it is</span>
<span class="c"># 10x faster than when blit=False)</span>
<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> 
                               <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> 
                               <span class="n">frames</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                               <span class="n">interval</span><span class="o">=</span><span class="n">actual_playback_rate</span><span class="p">,</span>
                               <span class="n">blit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Start the animation for real this time. Based on the args provided,</span>
<span class="c"># the animation will play from start to finish and then loop to the</span>
<span class="c"># start and play over again. This repeats until you close the matplotlib window.</span>
<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> 
                               <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> 
                               <span class="n">frames</span><span class="o">=</span><span class="n">sample_frame_count</span><span class="p">,</span> 
                               <span class="n">interval</span><span class="o">=</span><span class="n">actual_playback_rate</span><span class="p">,</span>
                               <span class="n">blit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="data_processing.html" title="2:40-3:30 Processing Recorded Eye Data"
             >next</a> |</li>
        <li class="right" >
          <a href="adding_et_func.html" title="1:00 - 1:40pm: Incorporating Eye tracking into PsychoPy Experiments"
             >previous</a> |</li>
        <li><a href="../index.html">Py4ET 2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2013, Jonathan Peirce and Sol Simpson.
      Last updated on Aug 06, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
  </body>
</html>