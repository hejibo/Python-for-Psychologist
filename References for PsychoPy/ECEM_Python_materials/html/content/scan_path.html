
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Py4ET - Python Open Source Tools in Eye Movement Research 2013 &mdash; Scan Path Visualization of Eye Sample Data</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2013.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Py4ET - Python Open Source Tools in Eye Movement Research 2013" href="../index.html" /> 
  </head>
  <body>


<div id="header"  style="background-color: white">
<table width="100%" cellpadding="10">
<tr>
    <td style="text-align:right;vertical-align:middle">
<a href='http://www.nottingham.ac.uk'><img src="../_static/nott_logo.gif" alt="University of Nottingham" /></a>
</td>
</table>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">Py4ET 2013</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Scan Path Visualization of Eye Sample Data</a><ul>
<li><a class="reference internal" href="#example-plots">Example Plots</a></li>
</ul>
</li>
</ul>


          <div id="searchbox" style="display: none">
            <h3>Searches</h3>
            <form action="http://www.google.com/cse" id="cse-search-box">
                <input type="hidden" name="cx" value="partner-pub-0861691574026297:eyw5n7-ugep" />
                <input type="hidden" name="ie" value="ISO-8859-1" />
                <input type="text" name="q" size="20" />
                <input type="submit" name="sa" value="Go" />
            </form>
              <p class="searchtip" style="font-size: 90%">
              General
              </p>
            <script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Docs only
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="scan-path-visualization-of-eye-sample-data">
<span id="scanpath"></span><h1>Scan Path Visualization of Eye Sample Data<a class="headerlink" href="#scan-path-visualization-of-eye-sample-data" title="Permalink to this headline">¶</a></h1>
<p><strong>Scan path overlay plots</strong> are generally created using either:</p>
<ul class="simple">
<li>the eye tracker sample stream to generate the line segements for the scan path ( <strong>Sample Based Scan Paths</strong> )</li>
<li>the fixation (and possibly saccade) event stream generated by an event parser ( <strong>Fixation / Event Based Scan Paths</strong> )</li>
</ul>
<p>When a scan path overlay is sample based, areas of increased dwell time can usually be seen as the clustering of sample line segments within areas of the scene.</p>
<p>When an event based scan path is used, it is common for each fixation event to be plotted as a circle shape, often with each fixation circle diameter being scaled by the fixation event duration. Saccade events can be represented as lines joining the relevent surrounding fixation events, or fixations can simply be joined by lines anchored to each fixations center point, thereby not attempting to use any available saccadic information (angle, duration, etc.).</p>
<p>The scan path overlay code to follow uses an eye sample based approach.</p>
<p>To aid in the visualization of the temportal order of the sample scan trace, a color map is used, with the color ramp normalized to the start and end time of the sample data being plotted (the trial time). This is often a more effective way of relaying temporal information on the 2D scan path plot compared to cluttering the scan path with numbers giving the trial time of eveny Nth scan path segment, or the sample index, etc.</p>
<p>The basic steps involved in scan path visualization using eye data from the ioDataStore include:</p>
<ol class="upperalpha simple">
<li>Read eye sample (or if available eye fixation and sacade event) data from the ioDataStore.</li>
<li>Clean areas of data that are determined to have missing eye position fields.</li>
<li>Draw the screen background for the trial.</li>
<li>Draw eye position data over the screen background. (What you draw is up to you and will depend on the type of eye information being used in the plot).</li>
<li>Applying a color map to the scan path data using the time of the scan path data points as the reference into the color map.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># This Python Source File Available in python_source/data_visualization/scan_path.py</span>

<span class="kn">from</span> <span class="nn">psychopy.iohub.datastore.util</span> <span class="kn">import</span> <span class="n">ExperimentDataAccessUtility</span>
<span class="kn">from</span> <span class="nn">psychopy.iohub</span> <span class="kn">import</span> <span class="n">EventConstants</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">LineCollection</span>

<span class="kn">from</span> <span class="nn">common_workshop_functions</span> <span class="kn">import</span> <span class="n">processSampleEventGaps</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="c"># Load an ioDataStore file containing 1000 Hz sample data from a </span>
<span class="c"># head supported eye tracker that was recording the right eye.</span>
<span class="c"># </span>
<span class="n">dataAccessUtil</span><span class="o">=</span><span class="n">ExperimentDataAccessUtility</span><span class="p">(</span><span class="s">&#39;..\hdf5_files&#39;</span><span class="p">,</span><span class="s">&#39;head_supported_data.hdf5&#39;</span><span class="p">,</span> 
                                           <span class="n">experimentCode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sessionCodes</span><span class="o">=</span><span class="p">[])</span>

<span class="c">##### STEP A. #####</span>
<span class="c"># Retrieve a subset of the MONOCULAR_EYE_SAMPLE event attributes, for events that occurred</span>
<span class="c"># between each time period defined by the TRIAL_START and TRIAL_END trial variables of each entry</span>
<span class="c"># in the trial_conditions data table.</span>
<span class="c">#</span>
<span class="n">event_type</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">MONOCULAR_EYE_SAMPLE</span>
<span class="n">retrieve_attributes</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">,</span><span class="s">&#39;gaze_x&#39;</span><span class="p">,</span><span class="s">&#39;gaze_y&#39;</span><span class="p">,</span><span class="s">&#39;pupil_measure1&#39;</span><span class="p">,</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
<span class="n">trial_event_data</span><span class="o">=</span><span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">getEventAttributeValues</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span>
                            <span class="n">retrieve_attributes</span><span class="p">,</span>
                            <span class="n">conditionVariablesFilter</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="n">startConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_START@&#39;</span><span class="p">)},</span>
                            <span class="n">endConditions</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;time&#39;</span><span class="p">:(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s">&#39;@TRIAL_END@&#39;</span><span class="p">)})</span>

<span class="c"># No need to keep the hdf5 file open anymore...</span>
<span class="c">#</span>
<span class="n">dataAccessUtil</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Process and plot the sample data for each trial in the data file.</span>
<span class="c">#</span>
<span class="k">for</span> <span class="n">trial_index</span><span class="p">,</span><span class="n">trial_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trial_event_data</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
    <span class="c">##### STEP B. #####</span>
    <span class="c"># Find all samples that have missing eye position data and filter the eye position</span>
    <span class="c"># and pupil size streams so that the eye track plot is more useful. In this case that</span>
    <span class="c"># means setting position fields to NaN and pupil size to 0.</span>
    <span class="c">#</span>
    
    <span class="c"># Eye manufacturer specific missing data indicator</span>
    <span class="c">#</span>
    <span class="n">invalid_data_mask</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span><span class="o">==</span><span class="mi">0</span>

    
    <span class="c"># Get the needed left eye sample arrays </span>
    <span class="c">#</span>
    <span class="n">gaze_x</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_x</span>
    <span class="n">gaze_y</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">gaze_y</span>
    <span class="n">pupil_size</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">pupil_measure1</span>
    
    <span class="c"># Process the eye fields using the processSampleEventGaps function defined</span>
    <span class="c"># in the common_workshop_functions.py file. The last arguement of &#39;clear&#39;</span>
    <span class="c"># tells the function to set any x or y position missing data samples to NaN </span>
    <span class="c"># and to set the pupil size field to 0. The operations are preformed in-place</span>
    <span class="c"># on the numpy arrays passed to the function.</span>
    <span class="c"># The returned valid_data_periods is a list of each group of temporally adjacent </span>
    <span class="c"># samples that are valid, but providing a list where each element is the (start, stop)</span>
    <span class="c"># index for a given period of valid data.</span>
    <span class="c">#</span>
    <span class="n">valid_data_periods</span><span class="o">=</span><span class="n">processSampleEventGaps</span><span class="p">(</span><span class="n">gaze_x</span><span class="p">,</span><span class="n">gaze_y</span><span class="p">,</span>
                                                   <span class="n">pupil_size</span><span class="p">,</span>
                                                   <span class="n">invalid_data_mask</span><span class="p">,</span>
                                                   <span class="s">&#39;clear&#39;</span><span class="p">)</span>
                                                   
    <span class="c"># get the array of sample times for the current trial</span>
    <span class="c">#</span>
    <span class="n">time</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">time</span>

    <span class="c"># Start plotting for the trial</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

    <span class="c">##### STEP C. #####</span>
    <span class="c"># Create Image background for each trial scanpath</span>
    <span class="c"># Get the condition variable set used for the current trial</span>
    <span class="c">#</span>
    <span class="n">condition_set</span><span class="o">=</span><span class="n">trial_data</span><span class="o">.</span><span class="n">condition_set</span>    
    <span class="c"># Get the image name and trial_id from the condition data for</span>
    <span class="c"># the trial.</span>
    <span class="c">#</span>
    <span class="n">image_name</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">IMAGE_NAME</span>
    <span class="n">trial_id</span><span class="o">=</span><span class="n">condition_set</span><span class="o">.</span><span class="n">trial_id</span>    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&quot;Trial {0}: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trial_id</span><span class="p">,</span><span class="n">image_name</span><span class="p">))</span>
    <span class="c"># Load the image</span>
    <span class="c">#</span>
    <span class="n">trial_image_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s">&quot;./images/&quot;</span><span class="o">+</span><span class="n">image_name</span><span class="p">))</span>
    <span class="c"># Get background image size</span>
    <span class="c">#</span>
    <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">trial_image_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ihw</span><span class="p">,</span><span class="n">ihh</span><span class="o">=</span><span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="c"># Draw the image to the plot</span>
    <span class="c">#</span>
    <span class="n">bip</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">trial_image_array</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">ihw</span><span class="p">,</span> <span class="n">ihw</span><span class="p">,</span><span class="o">-</span><span class="n">ihh</span><span class="p">,</span> <span class="n">ihh</span><span class="p">))</span>
    
    <span class="c">##### STEP D. #####</span>
    <span class="c"># To create the scan path data for the plot, convert the two 1D numpy</span>
    <span class="c"># arrays into one 2D array of shape (num_samples,2), where the second</span>
    <span class="c"># dimention is the x,y position for every sample in num_samples.</span>
    <span class="c">#</span>
    <span class="n">sample_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">gaze_x</span><span class="p">,</span> <span class="n">gaze_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="c"># To create the csan path graphics, we will create one line for every sample</span>
    <span class="c"># position point by specifying the start and end point of each line as</span>
    <span class="c"># x1,y1,x2,y2 ... xn-1,yn-1,xn,yn, where n == the number of sample points</span>
    <span class="c"># in the trial.</span>
    <span class="c">#</span>
    <span class="n">sample_segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sample_points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sample_points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Create the actual matplotlib line graphics group, and use the built in</span>
    <span class="c"># color map &#39;YlOrRd&#39;, meaning Yellow-&gt;Orange-&gt;Red</span>
    <span class="c">#</span>
    <span class="n">scan_path_line_collection</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">sample_segments</span><span class="p">,</span> 
                                               <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s">&#39;YlOrRd&#39;</span><span class="p">),</span>
                                               <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">scan_path_line_collection</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="n">scan_path_line_collection</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">scan_path_line_collection</span><span class="p">)</span>
    
    <span class="c">##### STEP E. #####</span>
    <span class="c"># Display the color bar and different sample times associated with the </span>
    <span class="c"># different colors in the color range.</span>
    <span class="c">#</span>
    <span class="n">cb</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scan_path_line_collection</span><span class="p">)</span>

    <span class="c"># Give the Color Bar a title</span>
    <span class="c">#</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">&quot;Trial Time (sec)&quot;</span><span class="p">)</span> 

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
</pre></div>
</div>
<div class="section" id="example-plots">
<h2>Example Plots<a class="headerlink" href="#example-plots" title="Permalink to this headline">¶</a></h2>
<p>Right Eye Scan Path Using Eye Sample Data. Created with MatPlotLib</p>
<img alt="Right Eye Scan Path Using Eye Sample Data. Created with MatPlotLib." class="align-center" src="../_images/scan_path.png" style="width: 485px; height: 365px;" />
<p>Same Plot as above, Zoomed into a Small Area of the Image Viewed.</p>
<img alt="Same Plot as above, Zoomed into a Small Area of the Image Viewed." class="align-center" src="../_images/scan_path_zoomed.png" style="width: 480px; height: 360px;" />
</div>
</div>


          </div>
        </div>
      </div>

      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">Py4ET 2013</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2013, Jonathan Peirce and Sol Simpson.
      Last updated on Aug 06, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
  </body>
</html>